\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c}{\PYGZsh{} ==== FUNCTIONS ====}
\PYG{c}{\PYGZsh{} The Tensor\PYGZhy{}Train product function}
\PYG{k}{function} \PYG{n}{√ó¬π}\PYG{p}{(}\PYG{n}{G}\PYG{o}{...}\PYG{p}{)}
    \PYG{c}{\PYGZsh{} Auxiliary variables with dimension/rank information}
    \PYG{n}{IR}  \PYG{o}{=} \PYG{p}{[}\PYG{n}{size}\PYG{p}{(}\PYG{n}{G}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]);} \PYG{p}{[}\PYG{n}{size}\PYG{p}{(}\PYG{n}{G}\PYG{p}{[}\PYG{n}{i}\PYG{p}{])[}\PYG{l+m+mi}{2}\PYG{o}{:}\PYG{k}{end}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{o}{:}\PYG{n}{length}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)]}\PYG{o}{...}\PYG{p}{]}
    \PYG{n+nb}{I}\PYG{p}{,}\PYG{n}{R} \PYG{o}{=} \PYG{p}{([}\PYG{n}{IR}\PYG{p}{[}\PYG{n}{i}\PYG{p}{][}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{length}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)],} \PYG{p}{[}\PYG{n}{IR}\PYG{p}{[}\PYG{n}{i}\PYG{p}{][}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{length}\PYG{p}{(}\PYG{n}{G}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{])}

    \PYG{c}{\PYGZsh{} Tensor\PYGZhy{}train product loop}
    \PYG{n}{ùìß} \PYG{o}{=} \PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb}{I}\PYG{o}{...}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{i} \PYG{k+kp}{in} \PYG{n}{CartesianIndices}\PYG{p}{(}\PYG{n}{ùìß}\PYG{p}{),} \PYG{n}{r} \PYG{k+kp}{in} \PYG{n}{CartesianIndices}\PYG{p}{((}\PYG{n}{R}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{],}\PYG{n}{R}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{],}\PYG{n}{R}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]))}
        \PYG{n}{ùìß}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{+=} \PYG{n}{G}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{][}\PYG{n}{i}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{],}\PYG{n}{r}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]]}\PYG{o}{*}\PYG{n}{G}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{][}\PYG{n}{r}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{],}\PYG{n}{i}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{],}\PYG{n}{r}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]]}\PYG{o}{*}\PYG{n}{G}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{][}\PYG{n}{r}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{],}\PYG{n}{i}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{],}\PYG{n}{r}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]]}\PYG{o}{*}\PYG{n}{G}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{][}\PYG{n}{r}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{],}\PYG{n}{i}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]]}
    \PYG{k}{end}
    \PYG{k}{return} \PYG{n}{ùìß}    \PYG{c}{\PYGZsh{} Returns the resulting tensor}
\PYG{k}{end}

\PYG{c}{\PYGZsh{} The Tensor\PYGZhy{}Train Singular Value Decomposition (TTSVD) algorithm}
\PYG{k}{function} \PYG{n}{TTSVD}\PYG{p}{(}\PYG{n}{ùìß}\PYG{p}{)}
    \PYG{n+nb}{I} \PYG{o}{=} \PYG{n}{size}\PYG{p}{(}\PYG{n}{ùìß}\PYG{p}{)}                                     \PYG{c}{\PYGZsh{} Auxiliary variable}
                                                    \PYG{c}{\PYGZsh{}}
    \PYG{n}{X¬π} \PYG{o}{=} \PYG{n}{reshape}\PYG{p}{(}\PYG{n}{ùìß}\PYG{p}{,} \PYG{p}{(}\PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{],}\PYG{n}{Œ†}\PYG{p}{(}\PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{o}{:}\PYG{l+m+mi}{4}\PYG{p}{])))}               \PYG{c}{\PYGZsh{} Unfolds the tensor [ùìß]‚ÇÅ ‚àà ‚Ñù(I‚ÇÅ,I‚ÇÇI‚ÇÉI‚ÇÑ)}
    \PYG{n}{U}\PYG{p}{,}\PYG{n}{Œ£}\PYG{p}{,}\PYG{n}{V} \PYG{o}{=} \PYG{n}{svd}\PYG{p}{(}\PYG{n}{X¬π}\PYG{p}{);}    \PYG{n}{Œ£} \PYG{o}{=} \PYG{k+kt}{Diagonal}\PYG{p}{(}\PYG{n}{Œ£}\PYG{p}{);}            \PYG{c}{\PYGZsh{} Computes the SVD [ùìß]‚ÇÅ = UŒ£V·¥¥}
    \PYG{n}{R‚ÇÅ} \PYG{o}{=} \PYG{n}{sum}\PYG{p}{(}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{Œ£}\PYG{p}{)} \PYG{o}{.\PYGZgt{}} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}                       \PYG{c}{\PYGZsh{} Gets the number of nonzero singular\PYGZhy{}values}
    \PYG{n}{U‚ÇÅ} \PYG{o}{=} \PYG{n}{U}\PYG{p}{[}\PYG{o}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÅ}\PYG{p}{];}  \PYG{n}{V‚ÇÅ} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Œ£}\PYG{o}{*}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{n}{·¥¥}\PYG{p}{)[}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÅ}\PYG{p}{,}\PYG{o}{:}\PYG{p}{]}          \PYG{c}{\PYGZsh{} Truncates pair (U,V) given R‚ÇÅ}
    \PYG{n}{G‚ÇÅ} \PYG{o}{=} \PYG{n}{U‚ÇÅ}                                         \PYG{c}{\PYGZsh{} Stores the 1st factor G‚ÇÅ ‚àà ‚Ñù(I‚ÇÅ,R‚ÇÅ)}
                                                    \PYG{c}{\PYGZsh{}}
    \PYG{n}{X¬≤} \PYG{o}{=} \PYG{n}{reshape}\PYG{p}{(}\PYG{n}{V‚ÇÅ}\PYG{p}{,} \PYG{p}{(}\PYG{n}{R‚ÇÅ}\PYG{o}{*}\PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{],} \PYG{n}{Œ†}\PYG{p}{(}\PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{o}{:}\PYG{l+m+mi}{4}\PYG{p}{])))}          \PYG{c}{\PYGZsh{} Unfolds the matrix X¬≤ = [V‚ÇÅ]‚ÇÅ ‚àà ‚Ñù(R‚ÇÅI‚ÇÇ,I‚ÇÉI‚ÇÑ)}
    \PYG{n}{U}\PYG{p}{,}\PYG{n}{Œ£}\PYG{p}{,}\PYG{n}{V} \PYG{o}{=} \PYG{n}{svd}\PYG{p}{(}\PYG{n}{X¬≤}\PYG{p}{);}    \PYG{n}{Œ£} \PYG{o}{=} \PYG{k+kt}{Diagonal}\PYG{p}{(}\PYG{n}{Œ£}\PYG{p}{);}            \PYG{c}{\PYGZsh{} Computes the SVD X¬≤ = UŒ£V·¥¥}
    \PYG{n}{R‚ÇÇ} \PYG{o}{=} \PYG{n}{sum}\PYG{p}{(}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{Œ£}\PYG{p}{)} \PYG{o}{.\PYGZgt{}} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}                       \PYG{c}{\PYGZsh{} Gets the number of nonzero singular\PYGZhy{}values}
    \PYG{n}{U‚ÇÇ} \PYG{o}{=} \PYG{n}{U}\PYG{p}{[}\PYG{o}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÇ}\PYG{p}{];}  \PYG{n}{V‚ÇÇ} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Œ£}\PYG{o}{*}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{n}{·¥¥}\PYG{p}{)[}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÇ}\PYG{p}{,}\PYG{o}{:}\PYG{p}{]}          \PYG{c}{\PYGZsh{} Truncates pair (U,V) given R‚ÇÇ}
    \PYG{n}{ùìñ‚ÇÇ} \PYG{o}{=} \PYG{n}{reshape}\PYG{p}{(}\PYG{n}{U‚ÇÇ}\PYG{p}{,} \PYG{p}{(}\PYG{n}{R‚ÇÅ}\PYG{p}{,} \PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{],} \PYG{n}{R‚ÇÇ}\PYG{p}{))}                \PYG{c}{\PYGZsh{} Reshapes the 2nd factor ùìñ‚ÇÇ ‚àà ‚Ñù(R‚ÇÅ,I‚ÇÇ,R‚ÇÇ)}
                                                    \PYG{c}{\PYGZsh{}}
    \PYG{n}{X¬≥} \PYG{o}{=} \PYG{n}{reshape}\PYG{p}{(}\PYG{n}{V‚ÇÇ}\PYG{p}{,} \PYG{p}{(}\PYG{n}{R‚ÇÇ}\PYG{o}{*}\PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{],} \PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]))}               \PYG{c}{\PYGZsh{} Unfolds the matrix X¬≥ = [V‚ÇÇ]‚ÇÅ ‚àà ‚Ñù(R‚ÇÇI‚ÇÉ,I‚ÇÑ)}
    \PYG{n}{U}\PYG{p}{,}\PYG{n}{Œ£}\PYG{p}{,}\PYG{n}{V} \PYG{o}{=} \PYG{n}{svd}\PYG{p}{(}\PYG{n}{X¬≥}\PYG{p}{);}    \PYG{n}{Œ£} \PYG{o}{=} \PYG{k+kt}{Diagonal}\PYG{p}{(}\PYG{n}{Œ£}\PYG{p}{);}            \PYG{c}{\PYGZsh{} Computes the SVD X¬≥ = UŒ£V·¥¥}
    \PYG{n}{R‚ÇÉ} \PYG{o}{=} \PYG{n}{sum}\PYG{p}{(}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{Œ£}\PYG{p}{)} \PYG{o}{.\PYGZgt{}} \PYG{l+m+mf}{1e\PYGZhy{}6}\PYG{p}{)}                       \PYG{c}{\PYGZsh{} Gets the number of nonzero singular\PYGZhy{}values}
    \PYG{n}{U‚ÇÉ} \PYG{o}{=} \PYG{n}{U}\PYG{p}{[}\PYG{o}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÉ}\PYG{p}{];}  \PYG{n}{V‚ÇÉ} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Œ£}\PYG{o}{*}\PYG{p}{(}\PYG{n}{V}\PYG{p}{)}\PYG{n}{·¥¥}\PYG{p}{)[}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÉ}\PYG{p}{,}\PYG{o}{:}\PYG{p}{]}          \PYG{c}{\PYGZsh{} Truncates pair (U,V) given R‚ÇÉ}
    \PYG{n}{ùìñ‚ÇÉ} \PYG{o}{=} \PYG{n}{reshape}\PYG{p}{(}\PYG{n}{U‚ÇÉ}\PYG{p}{,} \PYG{p}{(}\PYG{n}{R‚ÇÇ}\PYG{p}{,} \PYG{n+nb}{I}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{],} \PYG{n}{R‚ÇÉ}\PYG{p}{))}                \PYG{c}{\PYGZsh{} Reshapes the 3rd factor ùìñ‚ÇÉ ‚àà ‚Ñù(R‚ÇÇ,I‚ÇÉ,R‚ÇÉ)}
    \PYG{n}{G‚ÇÑ} \PYG{o}{=} \PYG{n}{V‚ÇÉ}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{R‚ÇÉ}\PYG{p}{,}\PYG{o}{:}\PYG{p}{]}                                 \PYG{c}{\PYGZsh{} Stores the 4th factor G‚ÇÑ ‚àà ‚Ñù(R‚ÇÉ,I‚ÇÑ)}

    \PYG{k}{return} \PYG{p}{(}\PYG{n}{G‚ÇÅ}\PYG{p}{,} \PYG{n}{ùìñ‚ÇÇ}\PYG{p}{,} \PYG{n}{ùìñ‚ÇÉ}\PYG{p}{,} \PYG{n}{G‚ÇÑ}\PYG{p}{)}                         \PYG{c}{\PYGZsh{} Returns the decomposition factors}
\PYG{k}{end}
\end{Verbatim}
